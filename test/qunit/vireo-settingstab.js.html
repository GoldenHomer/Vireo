<!DOCTYPE html>
<html>
<head>
<title>#{get 'title' /}</title>
<meta charset="utf-8">
<script src="@{'/public/javascripts/jquery-1.7.2.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/jquery-ui-1.8.21.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>                            
<script src="@{'/public/javascripts/bootstrap.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/vireo-admin.js'}" type="text/javascript" charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/vireo-settingstab.js'}" type="text/javascript" charset="${_response_encoding}"></script>      
      
#{qunit.include /}
</head>
<body>
</body>
<script language="JavaScript">

/** Functions to reset the dom between tests **/
function reset() {
    jQuery("body").empty();
    jQuery("body").append("<div id='alert-area'></div>");
}

test("test displaySortableItem", function() {
	expect(4);
	reset();
	
	jQuery("body").append("<ol id='test-list'><li id='original-li'></li></ol>");
	
	var $element = jQuery("#original-li");
	
	displaySortableItem('action',true,$element,'action-12','my action');
	
	equals(0,jQuery("#original-li").length);
	equals(1,jQuery("#action-12").length);
	equals(1,jQuery("#test-list li").length);
	equals(1,jQuery("#action-12 input").length);
});

/**
 * Test canceling an edit
 */
test("test sortableCancelEditHandler",function() {
    expect(2);
    reset();
    
    // Setup
    jQuery("body").append("<ol id='action-list' class='action-sortable'><li id='action_1'><span class='editing'><input type='text' value='Original Label' placeholder='Original Label'/><i class='icon-remove'></i><i class='icon-ok'></i></span></li></ol>");

    
    // Register the handler
    var handler = sortableCancelEditHandler();
    jQuery('.icon-remove').click(handler);
    
    // Simulate a click
    jQuery('.icon-remove').click();
    
    equals(1,jQuery(".action-editable").length);
    equals(0,jQuery(".editing").length);
    
});

/**
 * Test initiating an edit
 */
test("test sortableStartEditHandler",function() {
	expect(2);
	reset();
	
	// Setup
    jQuery("body").append("<ol id='action-list' class='action-sortable'><li id='action_1'><a class='action-editable' href='#'><em class='icon-pencil'></em> My Label</a></li></ol>");

	
	// Register the handler
	var handler = sortableStartEditHandler();
	jQuery('.action-editable').click(handler);
	
	// Simulate a click
	jQuery('.action-editable').click();
	
	equals(0,jQuery(".action-editable").length);
	equals(1,jQuery(".editing").length);
	
});

/**
 * Test saving an edit
 */
test("test sortableSaveEditHandler AJAX", function() {
	expect(6);
	reset();
	
	// Create the markup we will use for testing
    jQuery("body").append("<ol id='action-list' class='action-sortable'><li id='action_1'><span class='editing'><input type='text' value='Original Label' placeholder='Original Label'/><i class='icon-remove'></i><i class='icon-ok'></i></span></li></ol>");
   
	// Register the handler
	var handler = sortableSaveEditHandler("action","/ajax/test/url");
	jQuery(".icon-ok").click(handler);
	
	// Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
	
	// Simulate a click
	jQuery(".icon-ok").click()
	
	options.success({ success: 'true', id: '1', name: 'Something new'})
    
    equals('/ajax/test/url',options.url);
    equals('POST',options.type);
    equals('json',options.dataType);
    equals('action_1',options.data.actionId);
    equals('Original Label',options.data.name);
    
    equals(0,jQuery("#action_1 input").length);
	
});


/**
 * Test the reordering sortable custom actions
 */
test("test sortableUpdateHandler AJAX", function() {
    expect(4);
    reset();
    
    // Create the markup we will use for testing
    jQuery("body").append("<ol id='action-list' class='action-sortable'><li id='action_1'>one</li><li id='action_2'>two</li></ol><ul id='action-remove' class='action-sortable'><p class='info'><em class='icon-trash'></em> Remove items by dragging them to the trash can</p></ul>");
    
    // Register the handler
    var handler = sortableUpdateHandler("action", "/ajax/reorder/url","/ajax/remove/url");    
    var actionList = jQuery("#action-list");
    actionList.sortable({
        connectWith: ".action-sortable",
        placeholder: "placeholder"
    }).disableSelection();
    actionList.bind("sortupdate",handler)

    // Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
    
    // Simulate an reorder update
    actionList.trigger("sortupdate");
    
    options.success({ success: 'true'})
            
    equals('/ajax/reorder/url',options.url);
    equals('POST',options.type);
    equals('json',options.dataType);
    equals('action_1,action_2',options.data.actionIds);
});


/**
 * Test adding a new custom action
 */
test("Test saveAddActionHandler AJAX", function() {
    expect(6);
    reset();
    
    // Setup
    jQuery("body").append("<ol id='action-list' class='action-sortable'></ol>");
    jQuery("body").append("<div id='add-action-dialog'><fieldset><div class='control-group'><label class='control-label' for=''>New Action</label><div class='controls'><input type='text' class='input-large' id='add-action-name' value='action label as defined'/></div></div><div class='control-group'><div class='controls'><button id='add-action-save' class='btn btn-primary'>Add Action</button><button id='add-action-cancel' class='btn'>Cancel</button></div></div></fieldset></div>");
    
    // Register the handler
    var handler = saveAddActionHandler('action','ajax/url');
    jQuery("#add-action-save").click(handler);
    
    // Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
    
    jQuery("#add-action-save").click();
    
    options.success({ success: 'true', id:'99', name: 'action label as returned' });
    
    console.log("%o",options);
    
    equals('ajax/url',options.url);
    equals('POST',options.type);
    equals('json',options.dataType)
    equals(true,options.data.name.indexOf('defined') > 0);    
    
    equals(1,jQuery("#action_99").length);
    equals(true,jQuery("#action_99").text().indexOf('returned') > 0);
    
});

/**
 * Test canceling the addition of a new custom action
 */
test("Test cancelAddActionHandler", function() {
    expect(4);
    reset();
    stop();
    
    // Setup
    jQuery("body").append("<div id='add-action-dialog'><fieldset><div class='control-group error'><label class='control-label' for=''>New Action</label><div class='controls'><input type='text' class='input-large' id='add-action-name' value='action label as defined'/></div></div><div class='control-group'><div class='controls'><button id='add-action-save' class='btn btn-primary'>Add Action</button><button id='add-action-cancel' class='btn'>Cancel</button></div></div></fieldset></div>");
    
    // Call the the handler, we can do this simply because there's no ajax!
    cancelAddActionHandler('action')();
    
    setTimeout(function () {
        equals(1,jQuery("#add-action-dialog").length);
        equals('none',jQuery("#add-action-dialog").css("display"));
        equals('',jQuery("#add-action-name").val())
        equals(false,jQuery(".control-group").hasClass("error"));
        
        start();
    },1000);
});

/**
 * Test retrieving an email template.
 */
test("Test retrieveEmailTemplateHandler AJAX", function() {
	expect(7);
    reset();
    
    // Setup
    jQuery("body").append("<ol id='emailTemplate-list' class='emailTemplate-sortable'></ol>");
    jQuery("#emailTemplate-list").append("<li id='emailTemplate_1' class='retrieve'><div class='editing'><span>SYSTEM Email Test</span><form class='form-horizontal'><fieldset><div class='control-group'><label for='edit-emailTemplate-name' class='control-label'><strong>Name</strong></label><div class='controls'><input type='text' id='edit-emailTemplate-name' class='input-xxlarge' disabled='disabled'></div></div><div class='control-group'><label for='edit-emailTemplate-subject' class='control-label'><strong>Subject</strong></label><div class='controls'><input type='text' id='edit-emailTemplate-subject' class='input-xxlarge'></div></div><div class='control-group'><label for='edit-emailTemplate-message' class='control-label'><strong>Message</strong></label><div class='controls'><textarea class='input-xxlarge' id='edit-emailTemplate-message'></textarea></div></div><div class='control-group'><div class='controls'><button class='btn btn-primary' id='edit-emailTemplate-save'>Save</button><button class='btn disabled' id='edit-emailTemplate-delete' style=' '>Delete</button><button class='btn' id='edit-emailTemplate-cancel'>Cancel</button></div></div></fieldset></form></div></li>");
    
    // Register the handler
    var handler = retrieveEmailTemplateHandler('ajax/url');
    jQuery(".retrieve").click(handler);
    
    // Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
    
    jQuery(".retrieve").click();
    
    options.success({ success: 'true', id:'1', name: 'name returned', subject: 'subject returned', message: 'message returned' });
    
    equals('ajax/url',options.url);
    equals('POST',options.type);
    equals('json',options.dataType)
    equals('emailTemplate_1',options.data.emailTemplateId);
    
    equals('name returned',jQuery("#edit-emailTemplate-name").val())
    equals('subject returned',jQuery("#edit-emailTemplate-subject").val())
    equals('message returned',jQuery("#edit-emailTemplate-message").val())    
});


/**
 * Test removing an email template.
 */
test("Test removeEmailTemplateHandler AJAX", function() {
    expect(5);
    reset();
    stop();
    
    // Setup
    jQuery("body").append("<ol id='emailTemplate-list' class='emailTemplate-sortable'></ol>");
    jQuery("#emailTemplate-list").append("<li id='emailTemplate_1' class='retrieve'><div class='editing'><span>SYSTEM Email Test</span><form class='form-horizontal'><fieldset><div class='control-group'><label for='edit-emailTemplate-name' class='control-label'><strong>Name</strong></label><div class='controls'><input type='text' id='edit-emailTemplate-name' class='input-xxlarge' disabled='disabled'></div></div><div class='control-group'><label for='edit-emailTemplate-subject' class='control-label'><strong>Subject</strong></label><div class='controls'><input type='text' id='edit-emailTemplate-subject' class='input-xxlarge'></div></div><div class='control-group'><label for='edit-emailTemplate-message' class='control-label'><strong>Message</strong></label><div class='controls'><textarea class='input-xxlarge' id='edit-emailTemplate-message'></textarea></div></div><div class='control-group'><div class='controls'><button class='btn btn-primary' id='edit-emailTemplate-save'>Save</button><button class='btn disabled' id='edit-emailTemplate-delete' style=' '>Delete</button><button class='btn' id='edit-emailTemplate-cancel'>Cancel</button></div></div></fieldset></form></div></li>");
    
    // Register the handler
    var handler = removeEmailTemplateHandler('ajax/url');
    jQuery(".retrieve").click(handler);
    
    // Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
    
    jQuery(".retrieve").click();
    
    options.success({ success: 'true' });
    
    
    setTimeout(function () {
		equals('ajax/url',options.url);
		equals('POST',options.type);
		equals('json',options.dataType)
		equals('emailTemplate_1',options.data.emailTemplateId);
		
		equals(0,jQuery("#emailTemplate_1").length)   
        
        start();
    },1000);
});


/**
 * Test editing an email template.
 */
test("Test editEmailTemplateHandler AJAX", function() {
    expect(9);
    reset();
    stop();
    
    // Setup
    jQuery("body").append("<ol id='emailTemplate-list' class='emailTemplate-sortable'></ol>");
    jQuery("#emailTemplate-list").append("<li id='emailTemplate_1' class='retrieve'><div class='editing'><span>SYSTEM Email Test</span><form class='form-horizontal'><fieldset><div class='control-group'><label for='edit-emailTemplate-name' class='control-label'><strong>Name</strong></label><div class='controls'><input type='text' id='edit-emailTemplate-name' class='input-xxlarge' value='Original Name'></div></div><div class='control-group'><label for='edit-emailTemplate-subject' class='control-label'><strong>Subject</strong></label><div class='controls'><input type='text' id='edit-emailTemplate-subject' class='input-xxlarge' value='Original Subject'></div></div><div class='control-group'><label for='edit-emailTemplate-message' class='control-label'><strong>Message</strong></label><div class='controls'><textarea class='input-xxlarge' id='edit-emailTemplate-message'>Original Message</textarea></div></div><div class='control-group'><div class='controls'><button class='btn btn-primary' id='edit-emailTemplate-save'>Save</button><button class='btn disabled' id='edit-emailTemplate-delete' style=' '>Delete</button><button class='btn' id='edit-emailTemplate-cancel'>Cancel</button></div></div></fieldset></form></div></li>");
    
    // Register the handler
    var handler = editEmailTemplateHandler('ajax/url');
    jQuery(".retrieve").click(handler);
    
    // Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
    
    jQuery(".retrieve").click();
    
    options.success({ success: 'true', id: '1', name: 'New Name', subject: 'New Subject', message: 'New Message' });
    
    
    setTimeout(function () {
        equals('ajax/url',options.url);
        equals('POST',options.type);
        equals('json',options.dataType)
        equals('emailTemplate_1',options.data.emailTemplateId);
        equals('Original Name',options.data.name);
        equals('Original Subject',options.data.subject);
        equals('Original Message',options.data.message);

        
        equals(1,jQuery("#emailTemplate_1").length) 
        equals(' New Name',jQuery("#emailTemplate_1").text());
        
        start();
    },1000);
});

/**
 * Test updating profile.
 */
test("test mpProfileHandler AJAX", function() {
	expect(7);
	reset(); 
	
	// personal-bar
	jQuery("body").append("<div id='personal-bar'><a href='/profile'><b>Old username</b></a> | <a href='/logout'>Logout</a></div>");
	
	// my-profile box
	jQuery("body").append("<div class='side-box'><div id='my-profile' class='box-body'><div class='sub-heading'>NAME</div><ul class='unstyled'><li id='my-profile-username'>Old username</li></ul><div class='sub-heading'>EMAIL</div><ul class='unstyled'><li id='my-profile-email'>old@email.com</li></ul></div></div>");
	
	// my-preferences box
	jQuery("body").append("<div class='side-box'><div id='my-preferences' class='box-body'><div class='sub-heading'>DISPLAY NAME</div><ul class='unstyled'><li><fieldset class='control-group'><input id='displayName' class='input-medium' type='text' name='displayName' value='Old username' /></fieldset></li></ul><div class='sub-heading'>PREFERED EMAIL</div><ul class='unstyled'><li><fieldset class='control-group'><input id='currentEmailAddress' class='input-medium' type='text' name='currentEmailAddress' value='old@email.com' /></fieldset></li><li><fieldset class='control-group'><input id='ccEmail' type='checkbox' class='checkbox' name='ccEmail'> I want to receive a copy of all emails sent by the system on my behalf.</input></fieldset></li></ul></div></div>");  
	
	// Register the handler
	var handler = myProfileHandler("/ajax/test/url");
	jQuery("#displayName, #currentEmailAddress, #ccEmail").change(handler);
	
	// MOCK AJAX
	var options = null;
	jQuery.ajax = function(param) {
	    options = param;
	};
	
	// Simulate change in display name
	jQuery("#displayName").change();
	options.success({ success: 'true', displayName: 'new name', currentEmailAddress: 'new@email.com'});
	
	// Test the result
	equals('/ajax/test/url',options.url);
	equals('POST',options.type);
	equals('json',options.dataType);
	equals('displayName',options.data.field);
	equals('Old username',options.data.value);
	
	// Check that the markup was changed with the returned data
	equals('new name',jQuery("#my-profile ul:first-of-type li").text());
	equals('new@email.com',jQuery("#my-profile ul:last-of-type li").text());

});
 

/**
 * Test the toggeling of user preferences
 */
test("test userPreferenceHandler AJAX", function() {
	expect(4);
	reset();
	
	// Setup
	jQuery("body").append("<input id='test-preference' name='preference-name' type='checkbox' class='checkbox user-preference' checked='true'>");
	
	// Register the handler
	var handler = userPreferenceHandler("/ajax/test/url");
	jQuery("#test-preference").click(handler);
	
	// Mock AJAX
    var options = null;
    jQuery.ajax = function(param) {
        options = param;
    };
    
    // Simulate a click and ajax return
    jQuery("#test-preference").click();
    options.success({ success: 'true' });
    
    equals('/ajax/test/url',options.url);
    equals('POST',options.type);
    equals('json',options.dataType);
    equals('preference-name',options.data.field);

});

/**
 * Test the toggeling application settings (i.e. are submissions opened or closed)
 */
test("test applicationSettingsHandler AJAX", function() {
	expect(6);
	reset();
	
	// Create the buttons markup we will use for testing
	jQuery("body").append("<div id='parent' class='btn-group' data-toggle='buttons-radio'><button id='button1' name='test-button' class='btn application-toggle' value='true'>Open</button><button id='button2' name='test-button' class='btn application-toggle active'>Closed</button>");
	
	// Register the handler
	var handler = applicationSettingsHandler("/ajax/test/url");
	jQuery(".application-toggle").click(handler);

	// Mock AJAX
	var options = null;
	jQuery.ajax = function(param) {
		options = param;
	};
	
	
	// Simulate a click & ajax return
	jQuery("#button1").click();
	
	options.success({ success: 'true'})
		
	equals(true,jQuery("#button1").hasClass("active"));
	equals('/ajax/test/url',options.url);
	equals('POST',options.type);
	equals('json',options.dataType);
	equals('test-button',options.data.field);
	equals('true',options.data.value);	
});




</script>
</html> 

