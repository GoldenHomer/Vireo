#{extends 'main.html' /}
#{set title:'View Application' /}
#{set 'moreScripts'}
<script type="text/javascript" >

jQuery(document).ready(function() {
	
	
    jQuery("#submit_corrections").click(function() {
    	
        if (jQuery(this).val().indexOf("Are you sure?") >= 0) {
            return true;
        }
        jQuery(this).val("Are you sure?");
        jQuery("#submit-corrections-warning").slideToggle(500);
        return false;
    });
    
    jQuery("#replacePrimary").live("click",function() {
		var updateData = {"path":"@{Student.submissionView(subId)}","id":"#primaryDocumentWrap"};
		jQuery(updateData.id).fadeTo("slow",0.5,function() {
			jQuery(updateData.id).load(updateData.path+" "+updateData.id,{"replacePrimary":$(this).val()},function() {
				jQuery(updateData.id).fadeTo("fast",1);
				updateActionLog();
			});
		});
    	return false;
    });
    
    if( window.FormData !== undefined ) {
	    jQuery("#uploadPrimary").live("click",function() {
	    	var theFileSelector = document.getElementById("primaryFile");
			var theFiles = theFileSelector.files;
	   		var file = theFiles[0];
	   		if (file.type.match('application/pdf')) {
	   			var fData = {"file":{"name":"primaryDocument","file":file,"filename":file.name}};
	   			var postPath = "@{Student.submissionUploadPrimaryDocumentJSON(subId)}";
	   			var updateData = {"path":"@{Student.submissionView(subId)}","id":"#primaryDocumentWrap"};
				uploadFile(fData,postPath,updateData);
	   		} else {
				alert("The manuscript must be in PDF format");
			}
	    	return false;
	    });
	
	    jQuery("#uploadAdditional").click(function() {
	    	var theFileSelector = document.getElementById("additionalFile");
			var theFiles = theFileSelector.files;
	   		var file = theFiles[0];
			var fData = {"file":{"name":"additionalDocument","file":file,"filename":file.name},
						 "inputs":[{"name":"attachmentType","value":$("#documentType").val()}]};
			var postPath = "@{Student.submissionUploadAdditionalDocumentJSON(subId)}";
			var updateData = {"path":"@{Student.submissionView(subId)}","id":"#doAdditionalUploadWrap"};
			uploadFile(fData,postPath,updateData);
	
			return false;
	    });

	    function uploadFile(fData,postPath,updateData) {
			var formData = new FormData();
			formData.append(fData.file.name, fData.file.file, fData.file.filename);

			if (fData.inputs) {
				$.each(fData.inputs,function(key,input) {
		   			formData.append(input.name,input.value);
				});
			}

		 	var xhr = new XMLHttpRequest();
			xhr.open('POST', postPath, true);
			xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
			xhr.onload = function () {
							if (xhr.status === 200) {
							data = JSON.parse(xhr.response);
							if (data.success) {
								jQuery(updateData.id).fadeTo("slow",0.5,function() {
										jQuery(updateData.id).load(updateData.path+" "+updateData.id,function() {
											jQuery(updateData.id).fadeTo("fast",1);
											updateActionLog();
										});
									});
				    			}
							  } else {
								alert("Error uploading file");
							  }
							};
			xhr.send(formData);

			return false;
		}
	}

    jQuery("#addmsg").click(function(e) {
    	e.preventDefault();
		submitterId = jQuery(this).attr("id");
		statusId = submitterId+"Status";
		jQuery("#"+submitterId).prop("disabled",true);
		jQuery.ajax({
			url: '@{Student.submissionAddMessageJSON(subId)}',
			data:{
				'message': jQuery("#studentMessage").val(),
			},
			dataType:'json',
			type:'POST',
			success:function(data){
				if (data.success) {
					updateActionLog();
					jQuery("#studentMessage").val("");
					jQuery("#"+submitterId).prop("disabled",false);
				} else {
					jQuery("#"+statusId).html("Error adding message.");
					jQuery("#"+submitterId).prop("disabled",false);
				}
			},
			error:function(){
				jQuery("#"+statusId).html("Error communicating with the server.");
				jQuery("#"+submitterId).prop("disabled",false);
			}
		});
    });

    jQuery("#removeAdditional").live("click",function() {
    	var attachmentToRemove = [];
    	$(".doRemoveAttachmentIds:checked").each(function() {
    		attachmentToRemove.push($(this).val());
    	});
    	if (attachmentToRemove.length > 0) {
			var updateData = {"path":"@{Student.submissionView(subId)}","id":"#doAdditionalUploadWrap"};
			jQuery.ajax({
				url: '@{Student.submissionRemoveAdditionalDocumentsJSON(subId)}',
				data:{
					'attachmentToRemove': attachmentToRemove,
				},
				dataType:'json',
				type:'POST',
				success:function(data){
					if (data.success) {
						jQuery(updateData.id).fadeTo("slow",0.5,function() {
							jQuery(updateData.id).load(updateData.path+" "+updateData.id,function() {
								jQuery(updateData.id).fadeTo("fast",1);
								updateActionLog();
							});
						});
						updateActionLog();
					}
				},
				error:function(){
					alert("Error communicating with the server.");
				}
			});    	
    	}
		return false;
    });
    
    function updateActionLog() {
	    jQuery("#student-log-view").fadeTo("slow",0.5,function() {
			jQuery("#student-log-view").load("@{Student.submissionView(subId)} #student-log-view table",function() {
				jQuery("#student-log-view").fadeTo("fast",1);
			});
		});
	}
});
</script>
#{/set}
<ul class="breadcrumb">
	<li><a href="@{Application.index()}">Home</a> <span class="divider">/</span></li>
	#{if allowMultiple}
	<li><a href="@{Student.submissionList()}">Submissions</a> <span class="divider">/</span></li>
	#{/if}
	<li class="active">View</li>
</ul>
<div class="row pageHead">
	<h3 class="span11">View Application</h3>
</div>
<br/>
#{ifErrors}
<br/>
<ul class="red">
    #{errors}
        <li>${error}</li>
    #{/errors}
</ul>
</br>
#{/ifErrors}
<div id="confirmSubmit" class="row">
<form action="@{Student.submissionView(subId)}" method="post" class="form-horizontal" enctype="multipart/form-data">
	#{if sub.getState().isEditableByStudent() }
		<div id="correctionsWrap" class="alert alert-error">
			<p><strong><h4>Current Submission State: </h4>${sub.getState().getDisplayName()}!</strong></p>
			<p>The application requires you to make corrections. Please make the indicated corrections and upload the
			 new manuscript. After clicking the "Completing Corrections" button at the bottom of the page you will no
			 longer be able to edit the application.</p>
			<div class="form-actions row center">
			    <p id="submit-corrections-warning" class="hidden red">
			      After completing your corrections you will no longer be able to edit this application. Did you complete all the required changes, and upload a new manuscript?
			    </p>
				<input id="submit_corrections" type="submit" class="btn btn-primary ${sub.getPrimaryDocument() == null ? "disabled" : ""}" name="submit_corrections" value="Complete Corrections"/>
			</div>		
		</div>
	#{/if}
	#{else}
		<div class="row">
			<div class="alert">
				<p><strong><h4>Current Submission State:</h4> ${sub.getState().getDisplayName()}</strong></p>
				<p>Your Submission cannot be changed at this time.</p>
			</div>
		</div>
	#{/else}

    #{include 'viewSubmission.include' /}
	
	<legend>Uploaded Files</legend>
	#{ifErrors}
	<br/>
	<ul class="red">
	    #{errors}
	        <li>${error}</li>
	    #{/errors}
	</ul>
	</br>
	#{/ifErrors}
		#{ifEnabled PRIMARY_ATTACHMENT}
		<div class="control-group #{if errors.forKey('primaryDocument')}error#{/if}">
			<label class="control-label">#{fieldLabel PRIMARY_ATTACHMENT /}:</label>
			<div class="controls">
			#{if sub.getState().isEditableByStudent()}
				<div id="primaryDocumentWrap">
				#{if primaryDocument == null}
					<input type="file" id="primaryFile" class="input-file" name="primaryDocument"><br/>
			        <input type="submit" value="Upload" class="uploadBtn btn" id="uploadPrimary" name="uploadPrimary">
			        <br/>
			        <br/>               
		        #{/if}
		        #{else}
	                <p>
	                    <a href="@{Student.viewAttachment(subId,primaryDocument.getId(),primaryDocument.getName())}">${primaryDocument.getName()}</a>
	                    (${primaryDocument.getDisplaySize()})
	                    <input type="submit" value="Replace Manuscript" class="uploadBtn btn" id="replacePrimary" name="replacePrimary">
	                </p>
		        #{/else}
		        </div>
	        #{/if}		
			#{else}
				#{if primaryDocument != null}
				    <p>
				         <a href="@{Student.viewAttachment(subId,primaryDocument.getId(),primaryDocument.getName())}" target="_blank">${primaryDocument.getName()}</a>
				         (${primaryDocument.getDisplaySize()})
				     </p>
				#{/if}
				#{else}
				     <p><em>No primary document uploaded</em></p>
				#{/else}
			#{/else}
		</div>
	</div>
	#{/ifEnabled}
	#{ifEnabled [SUPPLEMENTAL_ATTACHMENT,SOURCE_ATTACHMENT,ADMINISTRATIVE_ATTACHMENT]}
    <div id="doAdditionalUploadWrap" class="control-group #{if errors.forKey('additionalDocument')}error#{/if}">
        <label class="control-label">Additional Documents:</label>
        <div class="controls">
            #{list items:additionalDocuments, as:'attachment'}
            <p>
            	#{if sub.getState().isEditableByStudent()}
            	<label>
            		<input type="checkbox" value="${attachment.getId()}" class="doRemoveAttachmentIds" name="attachmentToRemove">
                    <a href="@{Student.viewAttachment(subId,attachment.getId(),attachment.getName())}" target="_blank">
                    	${attachment.getName()}
                    </a> 
                    (${attachment.getType()} - ${attachment.getDisplaySize()})
                 </label>  
            	#{/if}
            	#{else}
	                <a href="@{Student.viewAttachment(subId,attachment.getId(),attachment.getName())}" target="_blank">${attachment.getName()}</a>
	                (${attachment.getType()} - ${attachment.getDisplaySize()})
	            #{/else}
            </p>
            #{/list}
            #{else}
            	<p><em>No additional documents uploaded</em></p>
            #{/else}
            
            #{if sub.getState().isEditableByStudent() && additionalDocuments.size() > 0 }
            	<input type="submit" value="Remove Selected" class="uploadBtn btn" id="removeAdditional" name="removeAdditional">                        
            #{/if}
        </div>
    </div>
	#{if sub.getState().isEditableByStudent()}	
	<br/>
	<br/>
	<div class="control-group">
        <label for="documentType" class="control-label"><b>Document type:</b></label>
        <div class="controls">
		<select id="documentType" class="input-select" name="attachmentType" style="margin-bottom:7px;">
            	<option value="">choose type...</option>
            	#{ifEnabled SUPPLEMENTAL_ATTACHMENT}
               	<option value="SUPPLEMENTAL">#{fieldLabel SUPPLEMENTAL_ATTACHMENT /}</option>
               	#{/ifEnabled}
               	#{ifEnabled SOURCE_ATTACHMENT}
               	<option value="SOURCE">#{fieldLabel SOURCE_ATTACHMENT /}</option>
               	#{/ifEnabled}
               	#{ifEnabled ADMINISTRATIVE_ATTACHMENT}
               	<option value="ADMINISTRATIVE">#{fieldLabel ADMINISTRATIVE_ATTACHMENT /}</option>
               	#{/ifEnabled}
            </select>
        </div>
		<label class="control-label" for="additionalFile"><span class="required-star">*</span>Browse for Additional Document:</label>
			<div class="controls">
				<input type="file" id="additionalFile" class="input-file" name="additionalDocument"><br/>
				<input id="uploadAdditional" type="submit" value="Upload" class="uploadBtn btn" name="uploadAdditional">
			</div>
    </div>
    #{/if}
    #{/ifEnabled}
    
    #{if feedbackDocuments != null && feedbackDocuments.size() > 0}
    <div class="control-group #{if errors.forKey('feedbackDocument')}error#{/if}">
        <label class="control-label"><b>Feedback Document${ feedbackDocuments.pluralize() }:</b></label>
        <div class="controls">
            #{list items:feedbackDocuments, as:'attachment'}
            <p>
	            <a href="@{Student.viewAttachment(subId,attachment.getId(),attachment.getName())}" target="_blank">${attachment.getName()}</a>
	            (${attachment.getDisplaySize()})
            </p>
            #{/list}
        </div>
    </div>
    #{/if}
    
    
    
	<legend>Application Activity</legend>
	<div id="student-log-view">
	<table role="presentation" class="span10 table table-striped table-bordered table-condensed">
		<thead>
			<tr>
				<th>Name</th>
				<th>Action</th>
				<th>Time</th>
			</tr>
		</thead>
		<tbody>
			#{list items:logs, as:'log'}
			#{if !log.isPrivate() }
			<tr>
				<td>${log.getPerson()?.getFormattedName(org.tdl.vireo.model.NameFormat.FIRST_LAST)}</td>
				<td>${log.getEntry()}</td>
				<td>${log.getActionDate().format('dd/MM/yyyy hh:mm:ss a')}</td>
			</tr>
			#{/if}
			#{/list}
		</tbody>
	</table>
	</div>

	<legend>Leave a message</legend>
	<div class="control-group">
		<label for="studentMessage" class="control-label"><b>Message:</b></label>
		<div class="controls">
			<textarea id="studentMessage" class="span6" style="height:200px;" name="studentMessage"></textarea>
            <input class="btn" id="addmsg" name="submit_addMessage" type="submit" value="Add Message" />
            <div id="addmsgStatus"></div>
            
            <br/>
		</div>
	</div>			
	<br/>
	<br/>
	<br/>
	<br/>
</form>
</div>
