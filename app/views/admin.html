<!DOCTYPE html>

<html lang="en">
    <head>
        <title>#{get 'title' /}</title>
        <meta charset="${_response_encoding}">
        <link href="@{'/public/stylesheets/admin.less'}" rel="stylesheet" type="text/css">                       
        #{get 'moreStyles' /}
        <link rel="shortcut icon" type="image/png" href="@{'/public/images/favicon.png'}">
        <script src="@{'/public/javascripts/jquery-1.7.2.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>                               
        <script src="@{'/public/javascripts/bootstrap.min.js'}" type="text/javascript" charset="${_response_encoding}"></script>     
        <script>        
        jQuery(document).ready(function(){
        	        	
        		/**
        		 *	Collapse/Expand Boxes in left Column
        		 * 
        		 *	<div class="side-box">
        		 *		<div class="box-head"></div> (Trigger)
        		 *		<div class="box-body"></div> (Expand/Collapse Element)
        		 *	</div>
        		 **/
        		 
        		jQuery(".box-head").click(function(){        			
        			var box = jQuery(this).parent(".side-box");
        			box.find(".box-body").toggle();
        			if(jQuery(this).hasClass("expanded")){
        				jQuery(this).removeClass("expanded");
        				jQuery(this).find(".expand").html("[+]");
        			} else {
        				jQuery(this).addClass("expanded");
        				jQuery(this).find(".expand").html("[-]");
        			}
        		});
        		
        		/**
        		 * Tab Navigation within the @ViewTab.view page.
        		 *
        		 * This function matches the class of the anchor tag
        		 * with the id of the div with class "edit-box-holder"
        		 **/
        		 
        		jQuery(".edit-holder .nav a").click(function(){
        			if(jQuery(this).parent("li").hasClass("active")){
        				//Do Nothing
        			} else {
        				jQuery(".edit-holder .nav li").each(function(){
        					jQuery(this).removeClass("active");
        				});
        				jQuery(this).parent("li").addClass("active");
        				var name = jQuery(this).attr("class");
        				jQuery(".edit-box-holder").each(function(){
        					jQuery(this).addClass("hidden");
        				});
        				jQuery(".edit-box-holder[id="+name+"]").removeClass("hidden");
        			}
        			
        		});
        		
        		/**
        		 * Show more elements.
        		 *
        		 * The more class indicates that in the parent of this element 
        		 * there are hidden children. All those hidden classes will be 
        		 * removed and this element will also be removed. So hidden is 
        		 * a one time thing, not a toggle.
        		 */
        		jQuery('.more').click(function(){
        			jQuery(this).parent().find(".hidden").each(function(){
        				jQuery(this).removeClass("hidden");
        			});
        			jQuery(this).remove();
        		});
        		
        		
        		/**
        		 * Confirm a link before following.
        		 *
        		 * Upon first click, this will replace the link's text with
        		 * "Are you sure?". Then upon a second click it will activate
        		 * the links destination
        		 */
        		 jQuery('.confirm').click(function() {
        			 if (jQuery(this).text().indexOf("Are you sure?") >= 0) {
        				 return true;
        			 } else {
        				 jQuery(this).text("(Are you sure?)");
        				 return false;
        			 }
        		 });
        		
        		/**
        		 * Swap from span to input field and back
        		 *
        		 *
        		 *
        		 */
        		 jQuery(".edit-box ul li span").live("click", function(){
        			if(jQuery(".editing").length == 0){
        				jQuery(".tooltip").remove();
        				jQuery(this).find(".tooltip-icon").remove();
	        			var editItem = jQuery(this);       
	        			var value = editItem.text().trim();
	        			
	        			if(value=="none"){
	        				value="";	        				
	        			}
	        			
	        			//Make back up info
	        			jQuery("body").append('<div id="backup">'+editItem.html().trim()+'</div>')
	        			
	        			//Text Areas
	        			if(editItem.hasClass("textarea")){
	        				editItem.replaceWith('<div id="'+editItem.attr("id")+'" class="editing textarea"><textarea class="field" textarea">'+value+'</textarea>&nbsp<i class="icon-remove"></i>&nbsp<i class="icon-ok"></i></div>');
	        			//Select Drop Downs
	        			} else if(editItem.hasClass("select")){
	        				var selectCode = '<div id="'+editItem.attr("id")+'" class="editing select"><select class="field">';
	        				selectCode += '<option value="">choose...</option>';
	        				selectCode += '<option value="'+value+'" selected="selected">'+value+'</option>';
	        				selectCode += '</select>&nbsp<i class="icon-remove"></i>&nbsp<i class="icon-ok"></i></div>';
	        				editItem.replaceWith(selectCode);
	        			//Input Fields
	        			} else {
	        				editItem.replaceWith('<div id="'+editItem.attr("id")+'" class="editing"><input class="field" type="text" value="'+value+'" />&nbsp<i class="icon-remove"></i>&nbsp<i class="icon-ok"></i></div>');
	        			}
	        			jQuery(".editing").setTimeout(jQuery(".editing").focus());
        			} 
        		});
        		
        		
        		jQuery(".icon-ok").live("click", function(){
        			jQuery("#backup").remove();
        			var classValue = '';
        			var fieldItem;
        			if(jQuery(".editing").hasClass("textarea")){
        				classValue = classValue + 'textarea ';
        				fieldItem = jQuery(".editing textarea");
        			} else if(jQuery(".editing").hasClass("select")){
        				classValue = classValue + 'select ';
        				fieldItem = jQuery(".editing select");
        			} else {
        				fieldItem = jQuery(".editing input");
        			}
        			var id=jQuery(".editing").attr("id");
        			var theValue;
        			if(fieldItem.val().trim()){
        				theValue = fieldItem.val();
        			}
        			jQuery(".editing").replaceWith('<div class="'+id+' progress progress-striped active"><div class="bar" style="width:100%"></div></div>');
        			        			
        			jQuery.ajax({
        				url:'@{ViewTab.updateJSON()}',
        				data:{
        					subId:'${submission.getId()}',
        					field:id,
        					value:theValue
        				},
        				dataType:'json',
        				type:'POST',
        				success:function(data){
        					var currentValue;
        					if(data.value){
        						currentValue = nl2br(data.value);
        					} else {
        						currentValue = "none";
        						classValue = classValue + 'empty ';
        					}
        					
        					if(data.success){
        						jQuery("div."+id).replaceWith('<span id="'+id+'" class="'+classValue+'">'+currentValue+'</span>');
        					} else {
        						jQuery("div."+id).replaceWith('<span id="'+id+'" class="error '+classValue+'">'+currentValue+' <a href="#" class="tooltip-icon" rel="tooltip" title="'+data.message+'"><div class="badge badge-important"><i class="icon-warning-sign icon-white"></i></div></a></span>');
	        					jQuery('.tooltip-icon').tooltip();
        					}
        				},
        				error:function(){
        					jQuery("div."+id).replaceWith('<span id="'+id+'" class="error '+classValue+'">Failed to Update <a href="#" class="tooltip-icon" rel="tooltip" title="There was an error with your request."><div class="badge badge-important"><i class="icon-warning-sign icon-white"></i></div></a></span>');
        					jQuery('.tooltip-icon').tooltip();
        				}
        				
        			})
        		});
        		
        		jQuery(".icon-remove").live("click", function(){
        			var classValue = '';
        			var fieldItem;
        			if(jQuery(".editing").hasClass("textarea")){
        				classValue = classValue + 'textarea ';
        				fieldItem = jQuery(".editing textarea");
        			} else if(jQuery(".editing").hasClass("select")){
        				classValue = classValue + 'select ';
        				fieldItem = jQuery(".editing select");
        			} else {
        				fieldItem = jQuery(".editing input");
        			}
        			var id=jQuery(".editing").attr("id");
        			
        			var currentValue = jQuery("#backup").html();
        			
        			jQuery(".editing").replaceWith('<span id="'+id+'" class="'+classValue+'">'+currentValue+'</span>');
        			
        			jQuery("#backup").remove();
        		});
        		
        		/**
        		 * Function to convert new lines in <br /> tags.
        		 */
        		function nl2br (str, is_xhtml) {   
        			var breakTag = (is_xhtml || typeof is_xhtml === 'undefined') ? '<br />' : '<br>';    
        			return (str + '').replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g, '$1'+ breakTag +'$2');
       			}

        });
        </script>
        
        #{get 'moreScripts' /}
        
    </head>
    <body>
    	<div id="mainContainer" class="container-fluid">
	    	<div id="header">	    		
	    		<span id="logo">&nbsp;</span>
	    		
	    		<div id="personal-bar">
					#{if session.get("personId") }
						<a href="@{Authentication.profile()}"><b>${session.get("firstName")} ${session.get("lastName")}</b></a> |
						<a href="@{Authentication.logout()}">Logout</a>
					#{/if}
					#{else}
					   <a href="@{Authentication.loginList()}">Login</a>
					#{/else}
				</div>
				
				<div id="tabs" class="pull-right">
					<ul class="nav nav-tabs">
						<li><a id="tab-list" href="@{FilterTab.list}" #{if nav=="list"}class="current"#{/if}>List</a></li>
						<li><a id="tab-view" href="@{ViewTab.view}" #{if nav=="view"}class="current"#{/if}>View</a></li>
						<li><a id="tab-log" href="@{FilterTab.log}" #{if nav=="log"}class="current"#{/if}>Log</a></li>
						<li><a id="tab-settings" href="@{Config.userPreferences}" #{if nav=="settings"}class="current"#{/if}>Settings</a></li>
					</ul>					
				</div>
				  	
	    	</div>
	    	<div id="body">
	       		#{doLayout /}
	        </div>
	        <div class="clear"></div>
	        <div id="footer" class="row">
	        	<p class="pull-left">Vireo 1.8 &copy; 2012 <a href="#">Texas Digital Library</a>. All Rights Reserved.
	        	<br />Valid <a href="#">XHTML 1.0</a>, <a href="#">CSS</a>. <a href="#">Section 508 Compliant</a>.</p>
	        </div>
    	</div>
    </body>
</html>
